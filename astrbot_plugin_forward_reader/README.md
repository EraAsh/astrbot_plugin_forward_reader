# Forward Reader v2.0.1 - 智能聊天记录分析助手

> 像朋友一样自然地帮你读懂聊天记录，支持多模态内容分析

[![AstrBot](https://img.shields.io/badge/AstrBot-≥3.4.0-blue)](https://github.com/Soulter/AstrBot)
[![License](https://img.shields.io/badge/License-AGPL--3.0-green)](LICENSE)
[![Version](https://img.shields.io/badge/Version-2.0.1-orange)](https://github.com/EraAsh/astrbot_plugin_forward_reader)

## 🌟 v2.0.1 重大更新

这是一个专为 [AstrBot](https://github.com/Soulter/AstrBot) 开发的智能插件，能够像真人朋友一样，**自然、流畅地帮你分析和理解 QQ 聊天记录**。

### 🆕 v2.0.1 新功能

#### 🖼️ 多模态支持
- **图片智能识别**：自动检测合并消息中的图片，使用多模态模型进行分析
- **视频内容标注**：识别视频内容并在分析中标注
- **智能降级**：如果当前 LLM 不支持多模态，自动切换到纯文字分析

#### 📂 多层嵌套处理
- **递归解析**：智能处理合并转发中嵌套的其他合并转发
- **深度限制**：可配置最大嵌套深度，防止无限递归
- **优雅降级**：能分析则分析，无法分析则跳过，不影响整体体验

#### 🧹 独立上下文分析
- **解决前言不对后语问题**：自动分析模式下，不再携带之前的对话上下文
- **纯净分析**：只针对当前合并消息内容进行评价描述
- **更准确的回复**：避免与之前对话内容混淆

### 核心理念：零技术痕迹的自然交互

传统机器人处理聊天记录时，往往会说"检测到合并转发消息""正在解析文件"之类的机械语言，让人感到疏离。

**Forward Reader v2.0.1** 彻底改变了这一点：

- ❌ **不再有**："检测到合并转发""解析中...""分析结果如下"
- ✅ **只有**："让我看看这段对话...""他们聊的是...""这个挺有意思的..."

## ✨ 核心特性

### 🤖 智能感知，无需指令

忘掉繁琐的指令吧！插件会自动感知你的意图：

| 你的行为 | Bot 的反应 |
|---------|-----------|
| 引用聊天记录 + 问"这聊了什么" | 🤔 "让我看看..." → 自然总结内容 |
| 直接发送聊天记录 | 💬 自动给出看法（可选） |
| 问"怎么看""什么意思" | 🧐 给出分析和观点 |
| 问"谁提到了xxx" | 🔍 帮你找到相关内容 |

### 💬 完全拟人的对话风格

- 使用口语化表达，像朋友间聊天
- 自动过滤"根据聊天记录"等机械前缀
- 支持自然语气词和个性化表达

### 🛡️ 优雅的异常处理

- 加密或损坏的记录 → **静默处理**，不打扰对话
- 空内容 → 自然回应"这段好像没什么内容呢"
- 解析失败 → 委婉表达困难，不暴露技术细节
- 图片无法识别 → 提示"图片看不清，但文字部分可以帮你分析"

### 🎯 多种触发模式

1. **引用分析**（推荐）：回复一条合并转发并提问
2. **直接分析**：自动处理直接发送的合并转发（独立上下文，不混淆）
3. **主动回复**：@Bot 时触发分析

## 🚀 快速开始

### 安装

```bash
# 方法1：通过 AstrBot WebUI 安装
# 在插件市场中搜索 "forward_reader" 并安装

# 方法2：手动安装
cd AstrBot/plugins
git clone https://github.com/EraAsh/astrbot_plugin_forward_reader
```

### 配置

在 AstrBot WebUI → 插件配置 中找到 Forward Reader：

```json
{
  "enable_smart_detection": true,    // 启用智能感知（建议开启）
  "enable_reply_analysis": true,     // 引用分析模式（推荐）
  "enable_direct_analysis": false,   // 直接分析（自动给评价，独立上下文）
  "enable_multimodal": true,         // 启用多模态分析
  "parse_nested_forward": true,      // 解析嵌套合并转发
  "show_thinking": true              // 显示思考提示
}
```

### 使用示例

#### 场景1：让 Bot 总结聊天记录

```
你：[引用一条聊天记录]
你：这聊了什么？

Bot：让我看看这段对话...
Bot：哦，他们主要在讨论周末聚会的安排，小明提议去爬山，
    小红说想看电影，最后大家决定周六先爬山周日看电影~
```

#### 场景2：直接发送聊天记录获取评价（v2.1.0 优化）

```
你：[直接发送一条合并转发]

Bot：让我看看这段对话...
Bot：这波操作真的笑死我了，完全就是用被批评的方式"自证"
    被批评的内容......而且还主动承认是OSCP考试的主人养的
    机器人，主人忙着考试没空管他，他就放飞自我了
```

> 注意：v2.1.0 优化后，直接分析模式不会携带之前的对话上下文，只针对当前合并消息内容进行分析。

#### 场景3：分析包含图片的聊天记录

```
你：[引用一条包含图片的聊天记录]
你：这是什么情况？

Bot：让我看看这段对话和图片...
Bot：这里有人发了一张表情包，然后大家都在讨论这个梗...
```

## ⚙️ 详细配置

| 配置项 | 类型 | 默认值 | 说明 |
|-------|------|-------|------|
| `enable_smart_detection` | bool | true | 启用智能感知模式，自动识别分析意图 |
| `enable_reply_analysis` | bool | true | 当用户引用/回复合并转发时自动分析 |
| `enable_direct_analysis` | bool | false | 直接发送的合并转发自动分析（独立上下文） |
| `enable_proactive_reply` | bool | false | @Bot 时触发主动分析 |
| `sensitivity` | float | 0.7 | 触发灵敏度（0.0-1.0） |
| `max_messages` | int | 200 | 单次分析最大消息数 |
| `show_thinking` | bool | true | 显示"让我看看..."等思考提示 |
| `enable_multimodal` | bool | true | 启用多模态分析（图片识别） |
| `max_images` | int | 5 | 单次分析最多处理的图片数量 |
| `parse_nested_forward` | bool | true | 解析嵌套的合并转发消息 |
| `max_nested_depth` | int | 3 | 嵌套解析最大深度 |

## 🎯 触发关键词

插件会自动识别以下类型的自然语言：

**总结类**：
- "总结一下" "什么内容" "聊了什么" "说啥了"

**分析类**：
- "怎么看" "什么意思" "分析一下" "评价一下"

**查询类**：
- "谁说的" "有没有提到" "关于..."

**疑问句**：
- 以"谁""什么""怎么""为什么"等开头的问句

## 🔒 隐私与异常处理

### 无法解析的内容

当遇到加密、损坏或特殊格式的聊天记录时：

- 不会在群内显示错误信息
- 不会说"解析失败"等技术性提示
- 可以选择静默忽略或自然过渡

### 多模态处理

- 自动检测 LLM 是否支持多模态
- 不支持时自动降级为纯文字分析
- 提供友好的提示而非错误信息

### 内容过滤

- 自动过滤"根据聊天记录"等机械表达
- 清理"分析结果如下"等技术前缀
- 保持对话的连贯性和自然性

## 📝 更新日志

### v2.0.1 (2024-02)

**新功能**：
- 🖼️ **多模态支持**：自动识别图片/视频内容，使用多模态模型分析
- 📂 **嵌套合并消息处理**：智能解析多层嵌套的合并转发
- 🧹 **独立上下文分析**：自动分析模式不携带之前对话，避免前言不对后语
- 📊 **全链路结构化日志追踪**：在关键节点输出 DEBUG/INFO 级日志
- 🔄 **消息ID哈希缓存去重**：防止同一内容被多次分析
- ⚡ **分析状态机管理**：idle/analyzing/completed 状态检测防止并发重复调用
- ⏱️ **延迟触发与优先级队列**：自动分析延迟触发，手动指令立即执行
- 🎯 **Token预算控制与分段摘要**：超长内容启用分段摘要策略

**改进**：
- 优化直接分析模式的提示词
- 新增多项配置选项（多模态、嵌套深度等）
- 改进错误处理机制
- 插件启停时资源正确释放
- 保持向下兼容

### v2.0.0 (2024-02)

**重大更新**：
- 🎉 **全新智能感知系统**：无需指令，自动理解意图
- 💬 **自然语言交互**：完全拟人化对话风格
- 🛡️ **优雅异常处理**：静默处理错误，无技术痕迹
- ⚙️ **更灵活的配置**：新增灵敏度、思考提示等选项
- 🎯 **多模式触发**：支持引用、直接、主动三种模式

### v1.1.1 (旧版本)

- 支持基础的合并转发分析
- 支持引用消息触发
- 使用 AstrBot 标准 LLM 流程

## ⚠️ 注意事项

1. **平台限制**：主要为 QQ (aiocqhttp) 平台开发，依赖 `get_forward_msg` API
2. **LLM 依赖**：需要配置有效的 LLM 提供商才能使用分析功能
3. **多模态要求**：图片分析需要 LLM 支持多模态（如 GPT-4V、Claude 3 等）
4. **资源消耗**：频繁分析长聊天记录会消耗较多 Token，请合理配置触发模式
5. **消息长度**：超长记录会被截断（默认200条），以保证响应速度

## 🤝 贡献

欢迎提交 Issue 和 PR！

- 发现 bug？请描述复现步骤
- 有新想法？欢迎提出功能建议
- 改进代码？请遵循现有代码风格

## 📄 许可证

[AGPL-3.0](LICENSE) © EraAsh

---

## ⭐ 支持项目

如果觉得这个插件对你有帮助，欢迎点个 Star 支持一下！

[![Star this repo](https://img.shields.io/github/stars/EraAsh/astrbot_plugin_forward_reader?style=social)](https://github.com/EraAsh/astrbot_plugin_forward_reader)

[🌟 点击这里给项目加星](https://github.com/EraAsh/astrbot_plugin_forward_reader)
